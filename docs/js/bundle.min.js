(function () {
    'use strict';

    const clean = (oldData) => {
        // console.log(oldData);

        let newData = oldData.data.results;

        return newData = newData.map((data) => {
            let creators = data.creators.items.reduce((creators,creator) => creators.concat(creator.name),[]);
            let characters = data.characters.items.reduce((acc, data) => acc.concat(data.name),[]);
            // console.log(characters)
            // let stories = data.stories.items.reduce((stories,story) => stories.concat(story),[]);
            return {
                id : data.id,
                name: data.name || data.title,
                thumbnail: data.thumbnail,
                creatorsName: creators,
                charactersName: characters
                // storiesThumbnail: stories.thumbnail
            }
        });

        // https://stackoverflow.com/questions/48435515/how-to-flatten-nested-array-of-object-using-es6
        // https://stackoverflow.com/questions/54733622/i-need-remove-unnecessary-json-objects-form-my-result-json-file-using-javascript
    };

    // create html element
    const createElement = (jsonData, selector) => {
        for (const comic of jsonData) {
            const className = `.${selector}`;
            const section = document.querySelector(className);
            section.insertAdjacentHTML('beforeend',
                `<article>
                <img src="${comic.thumbnail.path}.${comic.thumbnail.extension}">
                <a href="#${selector}/${comic.id}"><h2>${comic.name}</h2></a>
            </article>`);
        }
    };

    // create detail html element with classname
    const createDetail = (jsonData, selector) => {
        const className = `.${selector}`;
        const section = document.querySelector(className);
        let list = '';

        for (const creator of jsonData.creatorsName) {
            list += `<li>${creator}<li/>`;
        }

        const element = 
        `<article>
        <h2>${jsonData.name}</h2>
        <img src="${jsonData.thumbnail.path}.${jsonData.thumbnail.extension}">
        <h3>Creators</h3>
        <ul>${list}</ul>
    </article>`;

        section.insertAdjacentHTML('afterbegin', element);
    };

    // render overview page
    const allComics = (data) => {
        createElement(data, 'comics');
    };

    // render detailpage
    const comic = (data) => {
        createDetail(data, 'comic-detail');
    };

    // create endpoint url
    const baseUrl = new URL('https://gateway.marvel.com/v1/public/');
    const comicsEndpoint = new URL('comics', baseUrl);

    // https://blog.bitsrc.io/using-the-url-object-in-javascript-5f43cd743804
    // Thijs

    const queries = {
        dateDescriptor: 'thisMonth',
        orderBy: 'onsaleDate',
        limit: 10,
        ts: '1581025873',
        apikey: '22b5f2403c91db4fba23cad90a8b2ab7',
        hash: 'e6bb9dbff35775d2d8aed171d44888d4'
    };

    const searchParams = new URLSearchParams(queries);
    comicsEndpoint.search = searchParams;

    // fetched data and clean it
    const fetchData = async (url) => {
        const response = await fetch(url);
        const jsonData = await response.json();
        const cleanData = clean(jsonData);
        return cleanData;
    };

    // fetch data and find the correct comic with id
    const findComic = async (id) => {
        const comics = await fetchData(comicsEndpoint);
        const findData = comics.find((data) => data.id == id);
        return findData;
        // https://medium.com/poka-techblog/simplify-your-javascript-use-map-reduce-and-filter-bd02c593cc2d
    };

    // Get data for the overview page and render
    const getAllComics = async () => {
        const comics = await fetchData(comicsEndpoint);
        allComics(comics);
    };

    // Get data for the detail page and render
    const getComic = async (id) => {
        const comic$1 = await findComic(id);
        comic(comic$1);
    };

    // Search for comic with name
    const searchName = async (value) => {
        const comicsEndpoint = new URL('comics', baseUrl);
        const searchParams = new URLSearchParams(queries);
        searchParams.append('titleStartsWith', value);
        comicsEndpoint.search = searchParams;

        const searchResults = await fetchData(comicsEndpoint);
        allComics(searchResults);
    };

    var button = document.querySelector('button');
    const search = async () => {
        var value = document.querySelector('input').value;
        searchName(value);
    };

    button.addEventListener('click', search);

    const routes = () => {

        routie({
            '': function () {
                getAllComics();
                searchName();
            },
            'characters': function () {
                // api.getAllCharacters();
            },
            'comics': function () {
                getAllComics();
                searchName();
            },
            'comics/:id': function (id) {
                getComic(id);

            }
        });
    };

    routes();
    // https://superheroapi.com/api/1776314525838688/search/

}());
