(function () {
    'use strict';

    const clean = (oldData) => {
        console.log(oldData);

        let newData = oldData.data.results;
        return newData = newData.map((data) => {
            let creators = data.creators.items.reduce((creators,creator) => creators.concat(creator.name),[]);
            let stories = data.stories.items.reduce((stories,story) => stories.concat(story),[]);
            return {
                id : data.id,
                name: data.name || data.title,
                thumbnail: data.thumbnail,
                creatorsName: creators
                // storiesThumbnail: stories.thumbnail
            }
        });

        // https://stackoverflow.com/questions/48435515/how-to-flatten-nested-array-of-object-using-es6

        // https://stackoverflow.com/questions/54733622/i-need-remove-unnecessary-json-objects-form-my-result-json-file-using-javascript
    };

    const createElement = (jsonData, selector) => {

        for (const comic of jsonData) {
            const className = `.${selector}`;
            const section = document.querySelector(className);
            section.insertAdjacentHTML('beforeend',
                `<article>
                <h2>${comic.name}</h2>
                <img src="${comic.thumbnail.path}.${comic.thumbnail.extension}">
                <a href="#${selector}/${comic.id}">more</a>
            </article>`);

            // const section = document.querySelector(className);
            // const article = document.createElement('article');
            // const heading = document.createElement('h2');
            // const articleImage = document.createElement('img');
            // const articleUrl = document.createElement('a');
            // console.log('comic '+ comic.creatorsName);

            // articleUrl.textContent = `${comic.hasOwnProperty('name') ? comic.name : ''}`;

            // articleImage.src = `${comic.thumbnail.path}.${comic.thumbnail.extension}`; //template literals
            // articleUrl.href = `#${selector}/${comic.id}`;

            // heading.appendChild(articleUrl);
            // article.appendChild(articleImage);
            // article.appendChild(heading);
            // section.appendChild(article);
        }
    };

    const createDetail = (jsonData, selector) => {
        console.log(jsonData);
        for (const comic of jsonData) {
            const className = `.${selector}`;
            const section = document.querySelector(className);
            let list = '';

            for (const creator of comic.creatorsName) {
                list += `<li>${creator}<li/>`;
            }

            const element = 
            `<article>
            <h2>${comic.name}</h2>
            <img src="${comic.thumbnail.path}.${comic.thumbnail.extension}">
            <h3>Creators</h3>
            <ul>${list}</ul>
        </article>`;

            section.insertAdjacentHTML('beforeend', element);
        }
    };

    // render html element
    const allComics = async (data) => {
        await createElement(data, 'comics');
    };

    const comic = async (data) => {
        await createDetail(data, 'comic-detail');
    };

    const baseUrl = new URL('https://gateway.marvel.com/v1/public/');
    const comicsEndpoint = new URL('comics', baseUrl);
    const charactersEndpoint = new URL('characters', baseUrl);

    // https://blog.bitsrc.io/using-the-url-object-in-javascript-5f43cd743804
    // Thijs

    const queries = {
        dateDescriptor: 'thisMonth',
        orderBy: 'onsaleDate',
        limit : 10,
        ts : '1581025873',
        apikey : '22b5f2403c91db4fba23cad90a8b2ab7',
        hash : 'e6bb9dbff35775d2d8aed171d44888d4'
    };

    const searchParams = new URLSearchParams(queries);
    comicsEndpoint.search = searchParams;

    // fetched data
    const fetchData = (url) => {
        return new Promise ((resolve, reject) => {
            fetch(url)
                .then(response => response.json())
                .then(jsonData => {
                    console.log(clean(jsonData));
                    resolve(clean(jsonData));}
                );  
        })
    };

    // api.getAllComics
    // api.getComic
    // api.init

    // created an async function, because it otherwise gets called first before there's even data aka undefined
    const getAllComics = async () => {
        fetchData(comicsEndpoint)
        .then(data => allComics(data));
    };

    const getComic = async (id) => {
        fetchData(comicsEndpoint)
        .then(data => data.filter(data => data.id == id))
        .then(data => comic(data));
        // https://medium.com/poka-techblog/simplify-your-javascript-use-map-reduce-and-filter-bd02c593cc2d
    };

    // fetch data for overview page
    // but also for detailpage
    // check if the data already exist if not fetch data

    const routes = () => {
        routie({
            '': function () {
                // api.getOverview();
                // api.init();
            },
            'characters': function () {
                // api.getAllCharacters();
            },
            'comics': function () {
                getAllComics();        },
            'comics/:id': function (id) {
                getComic(id);
            }
        });
    };

    routes();
    // https://superheroapi.com/api/1776314525838688/search/

}());
